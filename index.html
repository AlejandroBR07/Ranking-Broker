<!DOCTYPE html>
<html lang="pt-BR" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Command Center v2.0: Geral | Aldeia</title>
    
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;900&display=swap" rel="stylesheet">
    <!-- Chart.js CDN for charts -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        /* Custom CSS Variables for Theming */
        :root {
            --bg-color-start: #020617; /* slate-950 */
            --bg-color-end: #111827;   /* gray-900 */
            --panel-bg: rgba(15, 23, 42, 0.6); /* slate-900 with opacity */
            --border-color: rgba(59, 130, 246, 0.2); /* blue-500 with opacity */
            --glow-color: #38bdf8; /* sky-400 */
            --glow-color-end: #06b6d4; /* cyan-500 */
            --text-primary: #f9fafb; /* gray-50 */
            --text-secondary: #9ca3af; /* gray-400 */
            --gold: #FFD700;
            --silver: #C0C0C0;
            --bronze: #CD7F32;
        }

        /* Base body styling */
        body { 
            font-family: 'Inter', sans-serif; 
            background: linear-gradient(135deg, var(--bg-color-start), var(--bg-color-end));
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
        }

        /* Animated grid background */
        #animated-bg {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            z-index: -1;
            background-image: 
                linear-gradient(rgba(56, 189, 248, 0.07) 1px, transparent 1px),
                linear-gradient(90deg, rgba(56, 189, 248, 0.07) 1px, transparent 1px);
            background-size: 50px 50px;
            animation: grid-pan 120s linear infinite;
        }

        @keyframes grid-pan {
            0% { background-position: 0% 0%; }
            100% { background-position: 100% 100%; }
        }

        /* Main command center panel styling */
        #command-center {
            width: 100%;
            max-width: 1600px;
            height: 90vh;
            max-height: 950px;
            background-color: var(--panel-bg);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid var(--border-color);
            border-radius: 2rem;
            display: flex;
            flex-direction: column;
            box-shadow: 0 0 50px rgba(0,0,0,0.5), 0 0 15px var(--glow-color), inset 0 0 10px rgba(56, 189, 248, 0.1);
            padding: 1.5rem 2rem;
            opacity: 0;
            transform: scale(0.95);
            animation: fadeInPanel 1s ease-out forwards;
        }

        @keyframes fadeInPanel {
            to { opacity: 1; transform: scale(1); }
        }

        /* Styling for content slides */
        .view-slide {
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.6s ease-in-out, transform 0.6s ease-in-out;
            transform: translateY(20px);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 2rem 0;
        }
        .view-slide.active { 
            opacity: 1; 
            visibility: visible; 
            transform: translateY(0); 
        }

        @keyframes fadeInChild {
            from { opacity: 0; transform: translateY(15px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .view-slide.active .fade-in-child { 
            animation: fadeInChild 0.6s ease-out forwards; 
        }
        
        /* Progress bar styling */
        #progress-bar {
            height: 100%;
            background: linear-gradient(90deg, var(--glow-color), var(--glow-color-end));
            transition: width 0.1s linear;
            box-shadow: 0 0 10px var(--glow-color);
            border-radius: 2px;
        }
        
        /* Styling for filter and ranking buttons */
        .filter-btn {
            color: var(--text-secondary); 
            background-color: rgba(30, 41, 59, 0.6);
            border: 1px solid var(--border-color);
            transition: all 0.3s ease;
        }
        .filter-btn:hover {
            background-color: rgba(55, 65, 81, 0.8);
            color: var(--text-primary);
            border-color: var(--glow-color);
        }
        .filter-btn-active {
            background: linear-gradient(90deg, var(--glow-color), var(--glow-color-end));
            color: #030712 !important;
            font-weight: 700;
            border-color: transparent;
            box-shadow: 0 0 15px rgba(56, 189, 248, 0.5);
        }

        /* Podium styling */
        .podium-1 .avatar-ring { border-color: var(--gold); box-shadow: 0 0 10px var(--gold); }
        .podium-2 .avatar-ring { border-color: var(--silver); box-shadow: 0 0 10px var(--silver); }
        .podium-3 .avatar-ring { border-color: var(--bronze); box-shadow: 0 0 10px var(--bronze); }
        
        /* Navigation dots styling */
        .nav-dots {
            position: absolute;
            bottom: 1.5rem; left: 50%;
            transform: translateX(-50%);
            display: flex; gap: 0.75rem;
        }
        .nav-dot {
            width: 10px; height: 10px;
            background-color: rgba(255, 255, 255, 0.2);
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .nav-dot:hover { background-color: rgba(255, 255, 255, 0.4); }
        .nav-dot.active { 
            background-color: var(--glow-color); 
            transform: scale(1.2); 
            box-shadow: 0 0 8px var(--glow-color); 
        }
        
        /* Custom scrollbar styles */
        .ranking-list::-webkit-scrollbar { width: 4px; }
        .ranking-list::-webkit-scrollbar-track { background: transparent; }
        .ranking-list::-webkit-scrollbar-thumb { 
            background-color: rgba(56, 189, 248, 0.5); 
            border-radius: 20px; 
        }

        /* Navigation arrows styling */
        .nav-arrow {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(30, 41, 59, 0.6);
            border: 1px solid var(--border-color);
            border-radius: 50%;
            width: 44px; height: 44px;
            display: flex; align-items: center; justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            opacity: 0;
            z-index: 20;
            color: white;
        }
        #command-center:hover .nav-arrow { opacity: 1; }
        .nav-arrow:hover { 
            background-color: rgba(55, 65, 81, 0.8); 
            border-color: var(--glow-color); 
            box-shadow: 0 0 10px var(--glow-color); 
        }
        #prev-slide { left: 0.5rem; }
        #next-slide { right: 0.5rem; }
    </style>
</head>
<body>
    <!-- Animated background element -->
    <div id="animated-bg"></div>

    <!-- Main Command Center Container -->
    <div id="command-center">
        <!-- Main Content Area with Slides -->
        <main id="slides-container" class="flex-grow relative">
            <!-- SLIDE 1: General Metrics -->
            <div id="view-general-metrics" class="view-slide active">
                <div class="w-full h-full flex flex-col items-center">
                    <header class="flex-shrink-0 mb-6 text-center">
                        <h1 class="text-4xl font-black text-white fade-in-child tracking-tight">M√©tricas Gerais</h1>
                    </header>
                    <div id="general-metrics-content" class="w-full max-w-6xl mx-auto grid grid-cols-1 lg:grid-cols-3 gap-8 items-start flex-grow">
                        <!-- General metrics cards will be rendered here by JavaScript -->
                    </div>
                </div>
            </div>

            <!-- SLIDE 2: Leaderboard -->
            <div id="view-leaderboard" class="view-slide">
                <div class="w-full h-full flex flex-col items-center">
                    <header class="flex-shrink-0 mb-4 text-center">
                        <h1 class="text-4xl font-black text-white fade-in-child tracking-tight">Ranking Geral de Brokers</h1>
                    </header>
                    <div id="leaderboard-content" class="flex-grow w-full max-w-7xl grid grid-cols-1 lg:grid-cols-3 gap-6 min-h-0">
                        <!-- Leaderboard lists will be rendered here by JavaScript -->
                    </div>
                </div>
            </div>
            
            <!-- SLIDE 3: Financial Chart -->
            <div id="view-chart" class="view-slide">
                <div class="w-full h-full flex flex-col items-center">
                    <header class="flex-shrink-0 mb-4 text-center">
                        <h1 class="text-4xl font-black text-white fade-in-child tracking-tight">An√°lise Gr√°fica Geral</h1>
                        <p id="chart-period-title" class="text-gray-400 fade-in-child" style="animation-delay: 100ms;"></p>
                    </header>
                    <div id="chart-content" class="flex-grow relative fade-in-child w-full max-w-6xl h-[400px]" style="animation-delay: 200ms;">
                        <canvas id="mainChart"></canvas>
                    </div>
                </div>
            </div>
        </main>

        <!-- Fixed Footer with Controls -->
        <footer class="flex-shrink-0">
            <div id="filter-container" class="mb-4 flex flex-wrap items-center justify-center gap-2">
                <!-- Period filters will be inserted here by JavaScript -->
            </div>
            <div id="nav-dots-container" class="nav-dots"></div>
            <div class="absolute bottom-4 right-4 text-xs text-gray-500 flex items-center gap-3">
                <span id="countdown-timer"></span>
                <button id="refresh-btn" title="Atualizar Agora" class="p-1.5 rounded-full text-gray-400 hover:bg-white/10 hover:text-white transition duration-300">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-rotate-cw"><path d="M21 2v6h-6"/><path d="M3 12a9 9 0 1 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"/></svg>
                </button>
            </div>
            <div id="progress-bar-container" class="w-full h-1 bg-white/5 absolute bottom-0 left-0 rounded-b-3xl overflow-hidden">
                <div id="progress-bar" style="width: 0%;"></div>
            </div>
        </footer>

        <!-- Navigation Arrows -->
        <button id="prev-slide" class="nav-arrow">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 18 9 12 15 6"></polyline></svg>
        </button>
        <button id="next-slide" class="nav-arrow">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><polyline points="9 18 15 12 9 6"></polyline></svg>
        </button>

        <!-- Loader overlay -->
        <div id="loader" class="absolute inset-0 flex items-center justify-center bg-slate-950/90 rounded-3xl z-30">
            <p class="text-gray-300 text-lg">Iniciando Command Center...</p>
        </div>
    </div>

    <script>
    (() => {
        // --- GLOBAL CONFIGURATION ---
        const DEPOSIT_WEBHOOK_URL = 'https://alejandroabc.app.n8n.cloud/webhook/42f1372b-15ea-4f55-9b71-0e8737ab2311';
        const INDICATIONS_WEBHOOK_URL = 'https://alejandroabc.app.n8n.cloud/webhook/7b5794a9-b105-47b5-85ed-004e54e05f7a';
        
        const DATA_REFRESH_INTERVAL = 1800 * 1000; // 30 minutes
        const VIEW_ROTATION_INTERVAL = 15 * 1000; // 15 seconds

        // --- APPLICATION STATE ---
        let rawDepositData = [];
        let rawIndicationsData = [];
        let mainChartInstance = null;
        let dataRefreshIntervalId, countdownIntervalId, rotationTimeoutId, animationFrameId;
        let rotationStartTime, rotationRemainingTime = VIEW_ROTATION_INTERVAL;
        let currentPeriod = 'all';
        let currentViewIndex = 0;
        let isPaused = false;
        
        const views = ['view-general-metrics', 'view-leaderboard', 'view-chart'];

        // DOM element references
        const DOM = {
            commandCenter: document.getElementById('command-center'),
            loader: document.getElementById('loader'),
            slides: views.map(id => document.getElementById(id)),
            progressBar: document.getElementById('progress-bar'),
            filterContainer: document.getElementById('filter-container'),
            dotsContainer: document.getElementById('nav-dots-container'),
            chartPeriodTitle: document.getElementById('chart-period-title'),
            generalMetricsContent: document.getElementById('general-metrics-content'), 
            leaderboardContent: document.getElementById('leaderboard-content'),
            countdownTimer: document.getElementById('countdown-timer'),
            refreshBtn: document.getElementById('refresh-btn'),
            prevBtn: document.getElementById('prev-slide'),
            nextBtn: document.getElementById('next-slide'),
        };
        
        // --- HELPER FUNCTIONS ---

        /**
         * ========================================================================
         * NORMALIZA√á√ÉO DE NOMES DE BROKERS
         * ========================================================================
         * Esta se√ß√£o garante que diferentes varia√ß√µes de nomes se refiram √†
         * mesma pessoa, mantendo os dados consistentes.
         */
        const mapaDeNomes = {
            // Mapeamentos para Jo√£o Trevisan
            'jo√£o trevisan': 'Jo√£o Trevisan',
            'trevisan': 'Jo√£o Trevisan',

            // Mapeamentos para Jo√£o Vidal
            'jo√£o vidal': 'Jo√£o Vidal',
            'vidal': 'Jo√£o Vidal',

            // Outros mapeamentos espec√≠ficos
            'luiz': 'Luiz Henrique',
        };

        // Normalizes broker names to a canonical version for consistent data aggregation.
        const getCanonicalName = (rawName) => {
            const name = (rawName || '').trim().toLowerCase();
            if (!name) return 'N√£o Identificado';

            // PRIORIDADE 1: Checar o mapa de nomes para correspond√™ncias exatas.
            if (mapaDeNomes[name]) {
                return mapaDeNomes[name];
            }

            // PRIORIDADE 2: Tratar casos de ambiguidade ou outras varia√ß√µes conhecidas.
            if (name === 'jo√£o' || name === 'joao') return 'Jo√£o (Ambiguidade)';
            
            // Mapeamentos por inclus√£o (menos espec√≠ficos)
            if (name.includes('vinicius cezar')) return 'Vinicius Cezar';
            if (name.includes('luiz henrique')) return 'Luiz Henrique';
            if (name.includes('brayan')) return 'Brayan Fran√ßa';
            if (name.includes('bruno')) return 'Bruno Nogueira';
            if (name.includes('gabrielli')) return 'Gabrielli Bonassoli';
            if (name.includes('myllena')) return 'Myllena';
            if (name.includes('joaquim')) return 'Joaquim';
            if (name.includes('laurence')) return 'Laurence';
            if (name.includes('anna')) return 'Anna';
            if (name.includes('alejandro')) return 'Alejandro';
            if (name.includes('bianca')) return 'Bianca';

            // PRIORIDADE 3: Fallback para capitalizar o nome se nenhuma regra corresponder.
            return (rawName || '').trim().split(' ')
                .map(word => word.charAt(0).toUpperCase() + word.slice(1).toLowerCase())
                .join(' ');
        };

        const parseCurrency = (value) => { 
            if (typeof value === 'number') return value; 
            if (typeof value === 'string' && value.trim() !== '') {
                let cleanedValue = value.replace(/[^\d.,-]/g, '');
                if (cleanedValue.includes(',') && cleanedValue.includes('.')) {
                    cleanedValue = cleanedValue.lastIndexOf(',') > cleanedValue.lastIndexOf('.') ? cleanedValue.replace(/\./g, '').replace(',', '.') : cleanedValue.replace(/,/g, '');
                } else if (cleanedValue.includes(',')) { 
                    cleanedValue = cleanedValue.replace(',', '.');
                }
                return parseFloat(cleanedValue) || 0;
            } 
            return 0; 
        };

        const formatCurrency = (value) => value.toLocaleString('en-US', { style: 'currency', currency: 'USD' });

        const parseDate = (dateStr) => { 
            if (!dateStr || typeof dateStr !== 'string') return null; 
            const parts = dateStr.split('/'); 
            if (parts.length === 3) {
                return new Date(parseInt(parts[2]), parseInt(parts[1]) - 1, parseInt(parts[0])); 
            }
            return null; 
        };

        function formatMonthYear(date) {
            if (!date) return null;
            const monthNames = ["jan", "fev", "mar", "abr", "mai", "jun", "jul", "ago", "set", "out", "nov", "dez"];
            return `${monthNames[date.getMonth()]}. ${date.getFullYear()}`;
        }
        
        // --- VIEW & SLIDE LOGIC ---

        function showView(index, isManual = false) {
            DOM.slides.forEach((slide, i) => slide.classList.toggle('active', i === index));
            document.querySelectorAll('.nav-dot').forEach((dot, i) => dot.classList.toggle('active', i === index));
            currentViewIndex = index;

            if (isManual) {
                clearTimeout(rotationTimeoutId);
                cancelAnimationFrame(animationFrameId);
                rotationRemainingTime = VIEW_ROTATION_INTERVAL;
                if (!isPaused) startRotation();
            }
        }

        function nextView(isManual = false) { 
            showView((currentViewIndex + 1) % views.length, isManual); 
        }

        function prevView() { 
            showView((currentViewIndex - 1 + views.length) % views.length, true); 
        }
        
        function updateProgressBar() {
            if (isPaused) return;
            const elapsedTime = Date.now() - rotationStartTime;
            const progress = (elapsedTime / rotationRemainingTime) * 100;
            DOM.progressBar.style.width = `${Math.min(progress, 100)}%`;
            animationFrameId = requestAnimationFrame(updateProgressBar);
        }
        
        function startRotation() {
            if (isPaused) return;
            rotationStartTime = Date.now();
            cancelAnimationFrame(animationFrameId); 
            animationFrameId = requestAnimationFrame(updateProgressBar); 
            rotationTimeoutId = setTimeout(() => {
                nextView(); 
                rotationRemainingTime = VIEW_ROTATION_INTERVAL; 
                startRotation(); 
            }, rotationRemainingTime);
        }

        function pauseRotation() { 
            if (isPaused) return; 
            isPaused = true; 
            clearTimeout(rotationTimeoutId); 
            cancelAnimationFrame(animationFrameId); 
            const elapsedTime = Date.now() - rotationStartTime; 
            rotationRemainingTime -= elapsedTime; 
        }

        function resumeRotation() { 
            if (!isPaused) return; 
            isPaused = false; 
            startRotation(); 
        }
        
        // --- DATA PROCESSING ---

        const MIN_DATE = new Date(2025, 6, 1); // July 1, 2025

        function processData(data, selectedPeriod) {
            const now = new Date(); 
            const today = new Date(now.getFullYear(), now.getMonth(), now.getDate()); 
            const startOfWeek = new Date(today); 
            startOfWeek.setDate(today.getDate() - today.getDay() + (today.getDay() === 0 ? -6 : 1));

            return data.map(item => {
                const rawDateString = item['col_6'] || (item['col_1'] ? item['col_1'].split(' ')[0] : null);
                const parsedDate = parseDate(rawDateString);
                return { 
                    ...item, 
                    parsedDate: parsedDate,
                };
            })
            .filter(item => {
                if (!item.parsedDate || item.parsedDate < MIN_DATE) return false; 

                const itemDate = new Date(item.parsedDate.getFullYear(), item.parsedDate.getMonth(), item.parsedDate.getDate());
                
                switch (selectedPeriod) {
                    case 'all': return true; 
                    case 'today': return itemDate.getTime() === today.getTime(); 
                    case 'this_week': return itemDate >= startOfWeek && itemDate <= today;
                    default: 
                        const [month, year] = selectedPeriod.split('_').map(Number);
                        return item.parsedDate.getMonth() === month && item.parsedDate.getFullYear() === year;
                }
            });
        }

        function calculateRankings(depositData, indicationsData) {
            const summary = {}; 

            const ensureBroker = (canonicalName) => {
                if (!canonicalName || canonicalName.includes('Ambiguidade')) return;
                if (!summary[canonicalName]) {
                    summary[canonicalName] = { 
                        brokerName: canonicalName, 
                        totalDeposito: 0, 
                        activationCount: 0,
                        totalIndications: 0, 
                        aldeiaPurchased: 0,
                        triboPurchased: 0
                    }; 
                }
            };

            depositData.forEach(item => { 
                const canonicalName = getCanonicalName(item['Broker']);
                ensureBroker(canonicalName);
                if (summary[canonicalName]) {
                    summary[canonicalName].totalDeposito += parseCurrency(item['col_5']); 
                    if (item['Ativa√ß√£o'] === 'Ativa√ß√£o') { 
                        summary[canonicalName].activationCount++; 
                    }
                }
            });

            indicationsData.forEach(item => {
                const canonicalName = getCanonicalName(item['BROKER:'] || item['Broker']);
                ensureBroker(canonicalName);

                if (summary[canonicalName]) {
                    const produto = item['Produto']; 
                    const comprou = item['Comprou']; 

                    if (produto) {
                        summary[canonicalName].totalIndications++;
                        if (produto.toLowerCase() === 'aldeia' && comprou?.toLowerCase() === 'sim') {
                            summary[canonicalName].aldeiaPurchased++;
                        } else if (produto.toLowerCase() === 'tribo' && comprou?.toLowerCase() === 'sim') {
                            summary[canonicalName].triboPurchased++;
                        }
                    }
                }
            });

            const allBrokers = Object.values(summary); 
            const valueRanking = [...allBrokers].sort((a, b) => b.totalDeposito - a.totalDeposito); 
            const activationRanking = [...allBrokers].sort((a, b) => b.activationCount - a.activationCount); 
            const indicationsRanking = [...allBrokers].sort((a, b) => b.totalIndications - a.totalIndications);
            
            return { valueRanking, activationRanking, indicationsRanking };
        }

        function calculateIndicationsOverall(data) {
            return data.reduce((acc, item) => {
                const produto = item['Produto'];
                const comprou = item['Comprou'];

                if (produto) {
                    acc.totalIndications++;
                    if (produto.toLowerCase() === 'aldeia') {
                        acc.aldeia.total++;
                        if (comprou?.toLowerCase() === 'sim') acc.aldeia.purchased++;
                    } else if (produto.toLowerCase() === 'tribo') {
                        acc.tribo.total++;
                        if (comprou?.toLowerCase() === 'sim') acc.tribo.purchased++;
                    }
                }
                return acc;
            }, {
                totalIndications: 0,
                aldeia: { total: 0, purchased: 0 },
                tribo: { total: 0, purchased: 0 }
            });
        }
        
        // --- RENDER FUNCTIONS ---

        function renderAll() {
            const periodText = document.querySelector(`.filter-btn[data-period="${currentPeriod}"]`)?.textContent || 'Per√≠odo Atual';
            
            const filteredDepositData = processData(rawDepositData, currentPeriod);
            const filteredIndicationsData = processData(rawIndicationsData, currentPeriod);

            const rankings = calculateRankings(filteredDepositData, filteredIndicationsData);
            const indicationsOverall = calculateIndicationsOverall(filteredIndicationsData); 

            DOM.chartPeriodTitle.textContent = periodText;
            renderGeneralMetrics(filteredDepositData, indicationsOverall); 
            renderLeaderboard(rankings); 
            renderAnalysisChart(filteredDepositData);
        }

        function renderGeneralMetrics(depositData, indicationsOverall) {
            const totalActivations = depositData.filter(item => item['Ativa√ß√£o'] === 'Ativa√ß√£o').length;
            const totalDeposits = depositData.reduce((sum, item) => sum + parseCurrency(item['col_5']), 0);

            const aldeiaConversion = indicationsOverall.aldeia.total > 0 ? (indicationsOverall.aldeia.purchased / indicationsOverall.aldeia.total) * 100 : 0;
            const triboConversion = indicationsOverall.tribo.total > 0 ? (indicationsOverall.tribo.purchased / indicationsOverall.tribo.total) * 100 : 0;

            DOM.generalMetricsContent.innerHTML = `
                <!-- Deposits Card -->
                <div class="fade-in-child bg-slate-900/50 p-6 rounded-3xl h-full border border-slate-700/50 flex flex-col" style="animation-delay: 200ms;">
                    <h2 class="text-xl font-bold text-center text-white mb-4 flex items-center justify-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-sky-400"><path d="M21 12V7H5a2 2 0 0 1 0-4h14v4"/><path d="M3 5v14a2 2 0 0 0 2 2h16v-5"/><path d="M18 12a2 2 0 0 0 0 4h4v-4Z"/></svg>
                        Dep√≥sitos & Ativa√ß√µes
                    </h2>
                    <div class="mt-4 text-center space-y-6 flex-grow flex flex-col justify-center">
                        <div><p class="text-4xl font-black text-sky-400">${formatCurrency(totalDeposits)}</p><p class="text-gray-400 text-sm uppercase tracking-wider">Total em Dep√≥sitos</p></div>
                        <div><p class="text-4xl font-black text-teal-400">${totalActivations}</p><p class="text-gray-400 text-sm uppercase tracking-wider">Total de Ativa√ß√µes</p></div>
                    </div>
                </div>
                <!-- Aldeia Indications Card -->
                <div class="fade-in-child bg-slate-900/50 p-6 rounded-3xl h-full border border-slate-700/50 flex flex-col" style="animation-delay: 300ms;">
                    <h2 class="text-xl font-bold text-center text-white mb-4 flex items-center justify-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-sky-400"><path d="m2 21 6-6"/><path d="m9 12-6 6"/><path d="M12 9b7 7 0 0 0-7 7"/><path d="M22 2 16 8"/><path d="m15 15 6-6"/><path d="M9 3a7 7 0 0 1 7 7"/></svg>
                        Indica√ß√µes Aldeia
                    </h2>
                    <div class="mt-4 text-center space-y-2 flex-grow flex flex-col justify-center">
                        <div class="grid grid-cols-2 gap-4">
                            <div><p class="text-3xl font-black text-teal-400">${indicationsOverall.aldeia.total}</p><p class="text-gray-400 text-xs uppercase">Total</p></div>
                            <div><p class="text-3xl font-black text-green-400">${indicationsOverall.aldeia.purchased}</p><p class="text-gray-400 text-xs uppercase">Compradas</p></div>
                        </div>
                        <div class="pt-2"><p class="text-3xl font-black text-sky-400">${aldeiaConversion.toFixed(1)}%</p><p class="text-gray-400 text-xs uppercase">Convers√£o</p></div>
                    </div>
                </div>
                <!-- Tribo Indications Card -->
                <div class="fade-in-child bg-slate-900/50 p-6 rounded-3xl h-full border border-slate-700/50 flex flex-col" style="animation-delay: 400ms;">
                    <h2 class="text-xl font-bold text-center text-white mb-4 flex items-center justify-center gap-2">
                         <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-sky-400"><path d="M12 22a2 2 0 0 0 2-2V2a2 2 0 0 0-4 0v18a2 2 0 0 0 2 2Z"/><path d="M6 12a2 2 0 0 0 2-2V2a2 2 0 0 0-4 0v8a2 2 0 0 0 2 2Z"/><path d="M18 12a2 2 0 0 0 2-2V2a2 2 0 0 0-4 0v8a2 2 0 0 0 2 2Z"/></svg>
                        Indica√ß√µes Tribo
                    </h2>
                    <div class="mt-4 text-center space-y-2 flex-grow flex flex-col justify-center">
                        <div class="grid grid-cols-2 gap-4">
                            <div><p class="text-3xl font-black text-teal-400">${indicationsOverall.tribo.total}</p><p class="text-gray-400 text-xs uppercase">Total</p></div>
                            <div><p class="text-3xl font-black text-green-400">${indicationsOverall.tribo.purchased}</p><p class="text-gray-400 text-xs uppercase">Compradas</p></div>
                        </div>
                        <div class="pt-2"><p class="text-3xl font-black text-sky-400">${triboConversion.toFixed(1)}%</p><p class="text-gray-400 text-xs uppercase">Convers√£o</p></div>
                    </div>
                </div>
            `;
        }
        
        function renderSingleRankingList(title, data, rankingType) {
            let contentHTML = `<div class="min-h-0 flex flex-col fade-in-child w-full">
                <h3 class="text-xl font-bold text-white mb-4 text-center">${title}</h3>`;
            if (data.length === 0) {
                contentHTML += `<div class="bg-black/20 rounded-xl flex-grow flex items-center justify-center"><p class="text-gray-500">Nenhum dado para este ranking.</p></div></div>`;
            } else {
                let listHTML = '<div class="space-y-2 overflow-y-auto flex-grow pr-2 ranking-list">';
                data.forEach((broker, index) => {
                    const rank = index + 1;
                    let valueText;
                    if (rankingType === 'value') {
                        valueText = formatCurrency(broker.totalDeposito);
                    } else if (rankingType === 'activation') {
                        valueText = `${broker.activationCount} Ativa√ß√µes`;
                    } else if (rankingType === 'indications') { 
                        valueText = `${broker.totalIndications} Indica√ß√µes`;
                    } else {
                        valueText = ''; 
                    }
                    const initials = broker.brokerName.split(' ').map(n => n[0]).join('').substring(0,2).toUpperCase(); 
                    
                    listHTML += `
                        <div class="flex items-center bg-black/20 p-2.5 rounded-xl transition duration-300 hover:bg-slate-700/50 ${rank <= 3 ? `podium-${rank}`: ''}">
                            <span class="text-md font-bold text-gray-400 w-8 text-center">${rank}¬∫</span>
                            <div class="w-9 h-9 rounded-full bg-slate-700 flex items-center justify-center font-bold text-sm text-white mx-2 border-2 avatar-ring">
                                ${initials}
                            </div>
                            <span class="font-semibold text-gray-200 flex-1 truncate">${broker.brokerName}</span>
                            <span class="text-sm font-semibold text-gray-300 ml-2 w-36 text-right">${valueText}</span>
                        </div>`;
                });
                listHTML += '</div>';
                contentHTML += listHTML + '</div>';
            }
            return contentHTML;
        }

        function renderLeaderboard(rankings) {
            DOM.leaderboardContent.innerHTML = 
                renderSingleRankingList('üèÜ DEP√ìSITOS', rankings.valueRanking, 'value') +
                renderSingleRankingList('‚ö° ATIVA√á√ïES', rankings.activationRanking, 'activation') +
                renderSingleRankingList('üí° INDICA√á√ïES', rankings.indicationsRanking, 'indications'); 
        }

        function renderAnalysisChart(data) {
            const summary = data.reduce((acc, item) => {
                const canonicalName = getCanonicalName(item['Broker']);
                if(!canonicalName || canonicalName.includes('Ambiguidade')) return acc;

                if(!acc[canonicalName]) acc[canonicalName] = { brokerName: canonicalName, totalDeposito: 0, depositoCount: 0 };
                
                const depositoValor = parseCurrency(item['col_5']); 
                if (depositoValor > 0) { 
                    acc[canonicalName].totalDeposito += depositoValor; 
                    acc[canonicalName].depositoCount++; 
                }
                return acc;
            }, {});
            
            const chartData = Object.values(summary).sort((a,b) => b.totalDeposito - a.totalDeposito).slice(0, 15);

            if (mainChartInstance) {
                mainChartInstance.destroy();
            }

            Chart.defaults.color = '#9ca3af'; 
            mainChartInstance = new Chart('mainChart', {
                type: 'bar',
                data: { 
                    labels: chartData.map(d => d.brokerName), 
                    datasets: [
                        { 
                            label: 'Valor Total Depositado', 
                            data: chartData.map(d => d.totalDeposito), 
                            backgroundColor: 'rgba(56, 189, 248, 0.6)', 
                            borderColor: 'rgba(56, 189, 248, 1)',
                            borderWidth: 1,
                            yAxisID: 'y' 
                        },
                        { 
                            label: 'Quantidade de Dep√≥sitos', 
                            data: chartData.map(d => d.depositoCount), 
                            type: 'line', 
                            borderColor: 'rgba(20, 184, 166, 1)', 
                            tension: 0.3, 
                            yAxisID: 'y1', 
                            pointBackgroundColor: '#06b6d4', 
                            pointRadius: 4 
                        }
                    ]},
                options: { 
                    responsive: true, 
                    maintainAspectRatio: false,
                    scales: { 
                        x: {
                            grid: { color: 'rgba(55, 65, 81, 0.2)' }
                        },
                        y: { 
                            type: 'linear', 
                            display: true, 
                            position: 'left', 
                            beginAtZero: true, 
                            grid: { color: 'rgba(55, 65, 81, 0.5)' }, 
                            ticks: { callback: v => formatCurrency(v) }
                        },
                        y1: { 
                            type: 'linear', 
                            display: true, 
                            position: 'right', 
                            beginAtZero: true, 
                            grid: { drawOnChartArea: false }, 
                            ticks: { stepSize: 1, precision: 0 } 
                        }
                    },
                    plugins: { 
                        tooltip: { 
                            backgroundColor: '#1f2937', 
                            titleFont: { weight: 'bold' },
                            callbacks: { 
                                label: c => { 
                                    let l = c.dataset.label || ''; 
                                    if(l) l += ': '; 
                                    if(c.dataset.yAxisID === 'y') l += formatCurrency(c.parsed.y); 
                                    else l += c.parsed.y; 
                                    return l; 
                                }
                            }
                        }
                    }
                }
            });
        }
        
        // --- INITIALIZATION & DATA LOADING ---

        async function fetchDataWithRetry(url, retries = 5, delay = 1000) {
            try {
                const response = await fetch(url);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return await response.json();
            } catch (error) {
                if (retries > 0) {
                    await new Promise(res => setTimeout(res, delay));
                    return fetchDataWithRetry(url, retries - 1, delay * 2); 
                } else {
                    console.error(`Failed to fetch data from ${url} after multiple attempts:`, error);
                    console.error(`Please check if the webhook "${url}" is active in n8n and if CORS is configured correctly.`);
                    return [];
                }
            }
        }

        async function fetchDataAndUpdate(initialLoad = false) {
            DOM.loader.querySelector('p').textContent = initialLoad ? 'Buscando dados gerais...' : 'Atualizando dados...';
            DOM.loader.classList.remove('hidden'); 

            try {
                [rawDepositData, rawIndicationsData] = await Promise.all([
                    fetchDataWithRetry(DEPOSIT_WEBHOOK_URL),
                    fetchDataWithRetry(INDICATIONS_WEBHOOK_URL)
                ]);
                
                populateFilters(rawDepositData.concat(rawIndicationsData));
                updateActiveFiltersAndTabs(); 
                renderAll(); 
                
                DOM.loader.classList.add('hidden'); 
                startRotation(); 
                startCountdownTimer(); 
            } catch (error) {
                console.error("Error loading or processing data:", error);
                DOM.loader.querySelector('p').textContent = 'Erro ao carregar dados. Verifique o console.';
            }
        }

        function populateFilters(data) {
            const months = new Map();
            data.forEach(item => { 
                const dateString = item['col_6'] || (item['col_1'] ? item['col_1'].split(' ')[0] : null);
                const date = parseDate(dateString); 
                
                if (date && date >= MIN_DATE) {
                    const monthYearKey = `${date.getMonth()}_${date.getFullYear()}`;
                    if (!months.has(monthYearKey)) {
                        months.set(monthYearKey, { value: monthYearKey, text: formatMonthYear(date), dateObj: new Date(date.getFullYear(), date.getMonth(), 1) });
                    }
                } 
            });
            
            const sortedMonths = Array.from(months.values()).sort((a, b) => b.dateObj - a.dateObj);
            
            DOM.filterContainer.innerHTML = `
                <button class="filter-btn px-4 py-1.5 rounded-md text-sm font-semibold" data-period="all">Geral</button>
                <button class="filter-btn px-4 py-1.5 rounded-md text-sm font-semibold" data-period="today">Hoje</button>
                <button class="filter-btn px-4 py-1.5 rounded-md text-sm font-semibold" data-period="this_week">Esta Semana</button>
                ${sortedMonths.map(m => `<button class="filter-btn px-4 py-1.5 rounded-md text-sm font-semibold" data-period="${m.value}">${m.text}</button>`).join('')}
            `;
            DOM.dotsContainer.innerHTML = views.map((_, i) => `<div class="nav-dot" data-index="${i}"></div>`).join('');

            const today = new Date();
            const currentMonthValue = `${today.getMonth()}_${today.getFullYear()}`;
            const currentMonthExists = sortedMonths.some(m => m.value === currentMonthValue);
            
            currentPeriod = currentMonthExists ? currentMonthValue : 'all';
        }

        function updateActiveFiltersAndTabs() {
            document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.toggle('filter-btn-active', btn.dataset.period === currentPeriod));
        }
        
        function startCountdownTimer() {
            clearInterval(countdownIntervalId); 
            let timeLeft = DATA_REFRESH_INTERVAL / 1000; 
            DOM.countdownTimer.textContent = `Atualiza em ${formatTime(timeLeft)}`;

            countdownIntervalId = setInterval(() => {
                timeLeft--;
                if (timeLeft <= 0) {
                    clearInterval(countdownIntervalId);
                    DOM.countdownTimer.textContent = 'Atualizando...';
                    fetchDataAndUpdate(false);
                } else {
                    DOM.countdownTimer.textContent = `Atualiza em ${formatTime(timeLeft)}`;
                }
            }, 1000);
        }

        function formatTime(seconds) {
            const minutes = Math.floor(seconds / 60);
            const remainingSeconds = seconds % 60;
            return `${minutes.toString().padStart(2, '0')}:${remainingSeconds.toString().padStart(2, '0')}`;
        }

        function setupEventListeners() {
            DOM.filterContainer.addEventListener('click', e => { 
                if (e.target.matches('.filter-btn')) { 
                    currentPeriod = e.target.dataset.period; 
                    updateActiveFiltersAndTabs(); 
                    renderAll(); 
                    showView(currentViewIndex, true); 
                } 
            });

            DOM.dotsContainer.addEventListener('click', e => { 
                if (e.target.matches('.nav-dot')) { 
                    showView(parseInt(e.target.dataset.index), true); 
                } 
            });

            DOM.prevBtn.addEventListener('click', () => prevView());
            DOM.nextBtn.addEventListener('click', () => nextView(true));

            DOM.refreshBtn.addEventListener('click', () => {
                clearTimeout(rotationTimeoutId);
                cancelAnimationFrame(animationFrameId);
                clearInterval(dataRefreshIntervalId);
                clearInterval(countdownIntervalId);
                fetchDataAndUpdate(false);
                dataRefreshIntervalId = setInterval(() => fetchDataAndUpdate(false), DATA_REFRESH_INTERVAL);
            });

            DOM.commandCenter.addEventListener('mouseenter', pauseRotation);
            DOM.commandCenter.addEventListener('mouseleave', resumeRotation);
        }

        function initialize() {
            setupEventListeners(); 
            fetchDataAndUpdate(true); 
            dataRefreshIntervalId = setInterval(() => fetchDataAndUpdate(false), DATA_REFRESH_INTERVAL);
        }

        window.onload = initialize;
    })();
    </script>
</body>
</html>

